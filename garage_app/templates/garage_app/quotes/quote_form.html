{% extends 'garage_app/base.html' %}

{% block title %}{{ title }} - MarKev{% endblock %}

{% block content %}
<style>
.quote-item-form {
    transition: all 0.3s ease;
    position: relative;
}

.quote-item-form:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,123,255,0.15) !important;
}

.form-control, .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: border-color 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
}

.btn-outline-danger:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}
</style>
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">{{ title }}</h1>
    </div>
</div>

<form method="post" id="quote-form">
    {% csrf_token %}
    
    <div class="row">
        <!-- Informations de base -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Informations de base</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.client.id_for_label }}" class="form-label">{{ form.client.label }} *</label>
                        {{ form.client }}
                        {% if form.client.errors %}
                            <div class="text-danger">{{ form.client.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.vehicle.id_for_label }}" class="form-label">{{ form.vehicle.label }}</label>
                        {{ form.vehicle }}
                        {% if form.vehicle.errors %}
                            <div class="text-danger">{{ form.vehicle.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.valid_until.id_for_label }}" class="form-label">{{ form.valid_until.label }} *</label>
                                {{ form.valid_until }}
                                {% if form.valid_until.errors %}
                                    <div class="text-danger">{{ form.valid_until.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Date limite de validité de la soumission
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            <i class="fas fa-sticky-note me-2"></i>{{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="text-danger">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.terms_conditions.id_for_label }}" class="form-label">
                            <i class="fas fa-file-contract me-2"></i>{{ form.terms_conditions.label }}
                        </label>
                        {{ form.terms_conditions }}
                        {% if form.terms_conditions.errors %}
                            <div class="text-danger">{{ form.terms_conditions.errors }}</div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Conditions générales de la soumission (optionnel)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Rabais -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-percent me-2"></i>Rabais</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.discount_percentage.id_for_label }}" class="form-label">{{ form.discount_percentage.label }}</label>
                                {{ form.discount_percentage }}
                                {% if form.discount_percentage.errors %}
                                    <div class="text-danger">{{ form.discount_percentage.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Sélectionnez un pourcentage de rabais prédéfini
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    {{ form.is_dealer_discount }}
                                    <label class="form-check-label" for="{{ form.is_dealer_discount.id_for_label }}">
                                        {{ form.is_dealer_discount.label }}
                                    </label>
                                    {% if form.is_dealer_discount.errors %}
                                        <div class="text-danger">{{ form.is_dealer_discount.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Cochez pour appliquer automatiquement 30% de rabais
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Note:</strong> Ces options sont mutuellement exclusives. Le rabais concessionnaire a priorité sur le menu déroulant.
                    </div>
                </div>
            </div>
        </div>

        <!-- Résumé -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Résumé</h5>
                </div>
                <div class="card-body">
                    {% if invoice %}
                        <p><strong>Numéro:</strong> {{ invoice.invoice_number }}</p>
                        <p><strong>Sous-total:</strong> ${{ invoice.subtotal|floatformat:2 }}</p>
                        <p><strong>TPS (5%):</strong> ${{ invoice.gst_amount|floatformat:2 }}</p>
                        <p><strong>TVQ (9.975%):</strong> ${{ invoice.qst_amount|floatformat:2 }}</p>
                        <hr>
                        <p><strong>Total:</strong> ${{ invoice.total_amount|floatformat:2 }}</p>
                    {% else %}
                        <p class="text-muted">Le résumé sera calculé après la création de la facture.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Éléments de facture -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Services et éléments de soumission</h5>
                </div>
                <div class="card-body">
                    {{ formset.management_form }}

                    <div id="quote-items">
                        {% for form in formset %}
                            <div class="quote-item-form border border-2 border-primary rounded-3 p-4 mb-4 bg-light shadow-sm">
                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                                {% endif %}

                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-primary mb-0">
                                        <i class="fas fa-cog me-2"></i>Service {{ forloop.counter }}
                                    </h6>
                                    {% if formset.can_delete and not forloop.first %}
                                        <div style="display: none;">{{ form.DELETE }}</div>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeQuoteItem(this)">
                                            <i class="fas fa-trash me-1"></i>Supprimer
                                        </button>
                                    {% endif %}
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <label class="form-label fw-bold">Service *</label>
                                            {{ form.service }}
                                            {% if form.service.errors %}
                                                <div class="text-danger small">{{ form.service.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label fw-bold">Prix ($)</label>
                                            {{ form.price }}
                                            {% if form.price.errors %}
                                                <div class="text-danger small">{{ form.price.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-edit me-1"></i>Description personnalisée
                                            </label>
                                            {{ form.description }}
                                            {% if form.description.errors %}
                                                <div class="text-danger small">{{ form.description.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Champs cachés -->
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-outline-primary btn-lg" onclick="addQuoteItem()">
                            <i class="fas fa-plus me-2"></i>Ajouter un service
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Boutons d'action -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{% if quote %}{% url 'garage_app:quote_detail' quote.id %}{% else %}{% url 'garage_app:quote_list' %}{% endif %}"
                   class="btn btn-secondary">Annuler</a>
                <button type="submit" class="btn btn-primary">
                    {% if quote %}Modifier la soumission{% else %}Créer la soumission{% endif %}
                </button>
            </div>
        </div>
    </div>
</form>

<script>
// Fonction pour mettre à jour les véhicules selon le client sélectionné
function updateVehicles() {
    const clientSelect = document.getElementById('id_client');
    const vehicleSelect = document.getElementById('id_vehicle');
    const clientId = clientSelect.value;

    if (!clientId) {
        vehicleSelect.innerHTML = '<option value="">---------</option>';
        return;
    }

    // Faire une requête AJAX pour récupérer les véhicules du client
    fetch(`/ajax/get-vehicles/${clientId}/`)
        .then(response => response.json())
        .then(data => {
            vehicleSelect.innerHTML = '<option value="">---------</option>';
            if (data.vehicles && data.vehicles.length > 0) {
                data.vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    const colorText = vehicle.color ? ` - ${vehicle.color}` : '';
                    option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.year})${colorText}`;
                    vehicleSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des véhicules:', error);
            vehicleSelect.innerHTML = '<option value="">Erreur de chargement</option>';
        });
}

// Fonction pour supprimer un élément de soumission
function removeQuoteItem(button) {
    const itemForm = button.closest('.quote-item-form');
    const deleteCheckbox = itemForm.querySelector('input[name$="-DELETE"]');

    if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        itemForm.style.display = 'none';
    }
}

function addQuoteItem() {
    const totalForms = document.querySelector('#id_quote_items-TOTAL_FORMS');
    const formNum = parseInt(totalForms.value);

    // Clone the last form
    const lastForm = document.querySelector('.quote-item-form:last-child');
    const newForm = lastForm.cloneNode(true);

    // Update form number in all inputs
    const inputs = newForm.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.name) {
            input.name = input.name.replace(/-\d+-/, `-${formNum}-`);
            input.id = input.id.replace(/-\d+-/, `-${formNum}-`);
            if (input.type !== 'hidden') {
                input.value = '';
            }
            // Décocher la case DELETE pour le nouvel élément
            if (input.name.endsWith('-DELETE')) {
                input.checked = false;
            }
        }
    });

    // Update labels
    const labels = newForm.querySelectorAll('label');
    labels.forEach(label => {
        if (label.getAttribute('for')) {
            label.setAttribute('for', label.getAttribute('for').replace(/-\d+-/, `-${formNum}-`));
        }
    });

    // Réafficher le formulaire au cas où il était caché
    newForm.style.display = 'block';

    // Add to DOM
    document.getElementById('quote-items').appendChild(newForm);

    // Update total forms count
    totalForms.value = formNum + 1;
}

// Initialiser les événements au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const clientSelect = document.getElementById('id_client');
    const discountSelect = document.getElementById('id_discount_percentage');
    const dealerCheckbox = document.getElementById('id_is_dealer_discount');

    // Gestion des rabais mutuellement exclusifs
    if (discountSelect && dealerCheckbox) {
        // Quand la case concessionnaire est cochée/décochée
        dealerCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Désactiver le menu déroulant et le remettre à "Aucun rabais"
                discountSelect.disabled = true;
                discountSelect.value = '';
                discountSelect.style.opacity = '0.5';
            } else {
                // Réactiver le menu déroulant
                discountSelect.disabled = false;
                discountSelect.style.opacity = '1';
            }
        });

        // Quand le menu déroulant change
        discountSelect.addEventListener('change', function() {
            if (this.value && this.value !== '') {
                // Décocher la case concessionnaire
                dealerCheckbox.checked = false;
            }
        });

        // Initialiser l'état au chargement de la page
        if (dealerCheckbox.checked) {
            discountSelect.disabled = true;
            discountSelect.value = '';
            discountSelect.style.opacity = '0.5';
        }
    }

    // Gestion combinée du changement de client (véhicules + rabais)
    if (clientSelect) {
        clientSelect.addEventListener('change', function() {
            const clientId = this.value;

            // 1. Mettre à jour les véhicules
            updateVehicles();

            // 2. Appliquer le rabais par défaut du client
            if (clientId) {
                fetch(`/ajax/get-client-info/${clientId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.client && data.client.default_discount_percentage > 0) {
                            // Appliquer le rabais par défaut du client si aucun rabais n'est déjà sélectionné
                            if (!dealerCheckbox.checked && (!discountSelect.value || discountSelect.value === '')) {
                                const defaultDiscount = data.client.default_discount_percentage.toFixed(2);

                                // Chercher la valeur correspondante dans le menu déroulant
                                for (let option of discountSelect.options) {
                                    if (option.value === defaultDiscount) {
                                        discountSelect.value = defaultDiscount;

                                        // Afficher un message informatif
                                        const alertDiv = document.createElement('div');
                                        alertDiv.className = 'alert alert-info alert-dismissible fade show mt-2';
                                        alertDiv.innerHTML = `
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Rabais automatique:</strong> ${defaultDiscount}% appliqué automatiquement pour ce client.
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        `;

                                        // Insérer l'alerte après la section rabais
                                        const discountCard = document.querySelector('.card:has(.fa-percent)');
                                        if (discountCard) {
                                            discountCard.insertAdjacentElement('afterend', alertDiv);

                                            // Supprimer l'alerte après 5 secondes
                                            setTimeout(() => {
                                                if (alertDiv.parentNode) {
                                                    alertDiv.remove();
                                                }
                                            }, 5000);
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des informations du client:', error);
                    });
            }
        });

        // Charger les véhicules si un client est déjà sélectionné au chargement de la page
        if (clientSelect.value) {
            updateVehicles();
        }
    }

    // Gestion de l'application automatique du prix du service
    function setupServicePriceAutoFill() {
        // Trouver tous les selects de service dans le formset
        const serviceSelects = document.querySelectorAll('select[name*="service"]');

        serviceSelects.forEach(function(serviceSelect) {
            // Supprimer les anciens event listeners pour éviter les doublons
            serviceSelect.removeEventListener('change', handleServiceChange);
            serviceSelect.addEventListener('change', handleServiceChange);
        });
    }

    function handleServiceChange() {
        const serviceId = this.value;

        if (serviceId) {
            // Trouver le champ prix correspondant dans la même ligne
            const formRow = this.closest('.invoice-item-form');
            const priceInput = formRow.querySelector('input[name*="price"]');

            if (priceInput) {
                // Récupérer le prix du service via AJAX
                fetch(`/ajax/get-services/`)
                    .then(response => response.json())
                    .then(data => {
                        const service = data.services.find(s => s.id == serviceId);
                        if (service && service.default_price) {
                            priceInput.value = service.default_price.toFixed(2);

                            // Afficher un message de confirmation
                            console.log(`Prix automatiquement appliqué: ${service.default_price}$ pour ${service.name}`);
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération du prix du service:', error);
                    });
            } else {
                console.error('Champ prix non trouvé dans la ligne');
            }
        } else {
            // Si aucun service sélectionné, vider le prix
            const formRow = this.closest('.invoice-item-form');
            const priceInput = formRow.querySelector('input[name*="price"]');
            if (priceInput) {
                priceInput.value = '';
            }
        }
    }

    // Initialiser l'auto-remplissage du prix au chargement de la page
    setupServicePriceAutoFill();

    // S'assurer que tous les champs item_type sont définis à "service"
    function ensureItemTypeService() {
        const itemTypeSelects = document.querySelectorAll('select[name*="item_type"]');
        itemTypeSelects.forEach(function(select) {
            select.value = 'service';
        });
    }

    // Appeler au chargement et quand de nouvelles lignes sont ajoutées
    ensureItemTypeService();

    // Réinitialiser l'auto-remplissage quand de nouvelles lignes sont ajoutées au formset
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                setupServicePriceAutoFill();
                ensureItemTypeService();
            }
        });
    });

    // Observer les changements dans le conteneur du formset
    const formsetContainer = document.querySelector('#quote-items');
    if (formsetContainer) {
        observer.observe(formsetContainer, { childList: true, subtree: true });
    }

    // Gestion des données du lettrage si disponibles
    {% if lettering_data %}
    const letteringData = JSON.parse('{{ lettering_data|escapejs }}');

    if (letteringData && letteringData.work_type === 'lettering') {
        // Ajouter automatiquement un service de lettrage
        setTimeout(function() {
            // Trouver le premier formulaire de service vide
            const serviceRows = document.querySelectorAll('.quote-item-form');
            if (serviceRows.length > 0) {
                const firstRow = serviceRows[0];

                // Remplir la description
                const descriptionField = firstRow.querySelector('input[name$="-description"]');
                if (descriptionField) {
                    let description = `Lettrage découpé: "${letteringData.lettering_text}"`;
                    if (letteringData.character_size === 'custom') {
                        description += ` (${letteringData.custom_size} cm)`;
                    } else {
                        description += ` (${letteringData.character_size})`;
                    }
                    descriptionField.value = description;
                }

                // Remplir le prix
                const priceField = firstRow.querySelector('input[name$="-unit_price"]');
                if (priceField && letteringData.lettering_total) {
                    priceField.value = parseFloat(letteringData.lettering_total).toFixed(2);
                }

                // Mettre la quantité à 1
                const quantityField = firstRow.querySelector('input[name$="-quantity"]');
                if (quantityField) {
                    quantityField.value = 1;
                }
            }
        }, 500); // Délai pour s'assurer que le DOM est prêt
    }
    {% endif %}
});
</script>
{% endblock %}
