{% extends 'garage_app/base.html' %}
{% load static %}

{% block title %}Calculateur de Prix - Lettrage{% endblock %}

{% block extra_css %}
<style>
    .calculator-card {
        background: var(--bs-card-bg, #1e1e1e);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        margin-bottom: 20px;
        border: 1px solid #555;
    }
    
    .calculator-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
    }
    
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0 20px;
    }
    
    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    
    .step::after {
        content: '';
        position: absolute;
        top: 15px;
        right: -50%;
        width: 100%;
        height: 2px;
        background: #555;
        z-index: 1;
    }
    
    .step:last-child::after {
        display: none;
    }
    
    .step.active::after {
        background: #667eea;
    }
    
    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #555;
        color: #e0e0e0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 5px;
        position: relative;
        z-index: 2;
    }
    
    .step.active .step-number {
        background: #667eea;
        color: white;
    }
    
    .step.completed .step-number {
        background: #28a745;
        color: white;
    }
    
    .form-section {
        padding: 20px;
        border-bottom: 1px solid #555;
        color: #e0e0e0;
    }

    .form-section:last-child {
        border-bottom: none;
    }

    .cost-breakdown {
        background: #2a2a2a;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #555;
    }

    .cost-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #555;
        color: #e0e0e0;
    }

    .cost-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.1em;
        color: #75b798;
    }

    .cost-item.total {
        border-top: 2px solid #75b798;
        margin-top: 10px;
        padding-top: 15px;
    }
    
    .btn-calculate {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .btn-calculate:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }

    /* Styles pour la sélection du type de travail */
    .work-type-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .work-type-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .work-type-card.selected {
        border-color: #667eea !important;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    /* Styles pour la section lettrage */
    .size-options .form-check {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #555;
        border-radius: 5px;
        background-color: #2a2a2a;
    }

    .size-options .form-check:hover {
        background-color: #3a3a3a;
    }

    .size-options .form-check-input:checked + .form-check-label {
        color: #667eea;
    }

    .lettering-breakdown {
        background-color: #2a2a2a;
        border: 1px solid #555;
        border-radius: 8px;
        padding: 15px;
    }

    .count-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        color: #e0e0e0;
    }

    .count-item.total {
        color: #75b798;
        font-size: 1.1em;
        margin-top: 10px;
    }

    /* Styles pour la taille personnalisée */
    .custom-size-input {
        margin-left: 20px;
    }

    .custom-size-input .form-control {
        background-color: #1e1e1e !important;
        border-color: #555 !important;
        color: #e0e0e0 !important;
    }

    .custom-size-input .input-group-text {
        background-color: #2a2a2a !important;
        border-color: #555 !important;
        color: #e0e0e0 !important;
    }
    
    .btn-save-quote {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .btn-save-quote:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        color: white;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .alert-calculation {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border: 1px solid #667eea;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="calculator-card">
                <div class="calculator-header">
                    <h1><i class="fas fa-calculator"></i> Calculateur de Prix - Lettrage & Wrapping</h1>
                    <p class="mb-0">Calculez automatiquement le prix de vos projets de lettrage et wrapping</p>
                </div>
                
                <!-- Indicateur d'étapes -->
                <div class="step-indicator mt-4">
                    <div class="step active" id="step-1">
                        <div class="step-number">1</div>
                        <div class="step-label">Client & Véhicule</div>
                    </div>
                    <div class="step" id="step-2">
                        <div class="step-number">2</div>
                        <div class="step-label">Type de Travail</div>
                    </div>
                    <div class="step" id="step-3">
                        <div class="step-number">3</div>
                        <div class="step-label">Spécifications</div>
                    </div>
                    <div class="step" id="step-4">
                        <div class="step-number">4</div>
                        <div class="step-label">Main-d'œuvre</div>
                    </div>
                    <div class="step" id="step-5">
                        <div class="step-number">5</div>
                        <div class="step-label">Prix Final</div>
                    </div>
                </div>
                
                <form id="letteringForm">
                    {% csrf_token %}
                    
                    <!-- Étape 1: Client & Véhicule -->
                    <div class="form-section">
                        <h4><i class="fas fa-user"></i> Informations de Base</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="client_id">Client *</label>
                                    <select class="form-control" id="client_id" name="client_id" required>
                                        <option value="">Sélectionnez un client...</option>
                                        {% for client in clients %}
                                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="vehicle_id">Véhicule *</label>
                                    <select class="form-control" id="vehicle_id" name="vehicle_id" required disabled>
                                        <option value="">Sélectionnez d'abord un client...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="vehicle_info" class="alert alert-info" style="display: none;">
                            <strong>Véhicule sélectionné:</strong> <span id="vehicle_details"></span><br>
                            <strong>Multiplicateur de complexité:</strong> <span id="complexity_multiplier"></span>
                        </div>
                    </div>

                    <!-- Étape 2: Type de travail -->
                    <div class="form-section">
                        <h4><i class="fas fa-tools"></i> Type de travail</h4>

                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label">Sélectionnez le type de travail :</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card work-type-card" data-type="wrapping" style="cursor: pointer; border: 2px solid #555;">
                                            <div class="card-body text-center">
                                                <i class="fas fa-car fa-3x text-primary mb-3"></i>
                                                <h5>Habillage / Wrapping</h5>
                                                <p class="text-muted">Calcul par surface (m²)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card work-type-card" data-type="lettering" style="cursor: pointer; border: 2px solid #555;">
                                            <div class="card-body text-center">
                                                <i class="fas fa-font fa-3x text-success mb-3"></i>
                                                <h5>Lettrage Découpé</h5>
                                                <p class="text-muted">Calcul par caractère</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="work_type" name="work_type" required>
                            </div>
                        </div>
                    </div>

                    <!-- Étape 3: Matériaux Wrapping -->
                    <div class="form-section" id="wrapping-section" style="display: none;">
                        <h4><i class="fas fa-layer-group"></i> Matériaux - Wrapping</h4>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="surface_area">Surface totale (m²) *</label>
                                    <input type="number" class="form-control" id="surface_area" name="surface_area" 
                                           step="0.01" min="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="waste_percentage">Taux de perte (%)</label>
                                    <input type="number" class="form-control" id="waste_percentage" name="waste_percentage" 
                                           value="15" step="0.1" min="0" max="50">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Surface avec perte</label>
                                    <input type="text" class="form-control" id="surface_with_waste" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="vinyl_material_id">Vinyle *</label>
                                    <select class="form-control" id="vinyl_material_id" name="vinyl_material_id" required>
                                        <option value="">Sélectionnez un vinyle...</option>
                                        {% for material in vinyl_materials %}
                                            <option value="{{ material.id }}" data-cost="{{ material.cost_per_sqm }}">
                                                {{ material.name }} - {{ material.cost_per_sqm }}$/m²
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="lamination_material_id">Lamination (optionnel)</label>
                                    <select class="form-control" id="lamination_material_id" name="lamination_material_id">
                                        <option value="">Aucune lamination</option>
                                        {% for material in lamination_materials %}
                                            <option value="{{ material.id }}" data-cost="{{ material.cost_per_sqm }}">
                                                {{ material.name }} - {{ material.cost_per_sqm }}$/m²
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Étape 3: Lettrage -->
                    <div class="form-section" id="lettering-section" style="display: none;">
                        <h4><i class="fas fa-font"></i> Lettrage Découpé</h4>

                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="lettering_text">Texte à lettrer *</label>
                                    <textarea class="form-control" id="lettering_text" name="lettering_text"
                                              rows="3" placeholder="Saisissez le texte à lettrer (ex: GARAGE MARKEV 2024)"></textarea>
                                    <small class="form-text text-muted">Saisissez exactement le texte qui sera découpé</small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Taille des caractères *</label>
                                    <div class="size-options">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="character_size" id="size_petit" value="petit">
                                            <label class="form-check-label" for="size_petit">
                                                <strong>Petit (2-5 cm)</strong><br>
                                                <small>Lettres: 2,00$ • Symboles: 2,50$</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="character_size" id="size_moyen" value="moyen">
                                            <label class="form-check-label" for="size_moyen">
                                                <strong>Moyen (6-15 cm)</strong><br>
                                                <small>Lettres: 3,50$ • Symboles: 4,40$</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="character_size" id="size_grand" value="grand">
                                            <label class="form-check-label" for="size_grand">
                                                <strong>Grand (16-30 cm)</strong><br>
                                                <small>Lettres: 5,00$ • Symboles: 6,25$</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="character_size" id="size_custom" value="custom">
                                            <label class="form-check-label" for="size_custom">
                                                <strong>Personnalisé (31+ cm)</strong><br>
                                                <div class="custom-size-input mt-2" style="display: none;">
                                                    <div class="input-group input-group-sm">
                                                        <input type="number" class="form-control" id="custom_size" name="custom_size"
                                                               placeholder="Taille" min="31" step="1">
                                                        <span class="input-group-text">cm</span>
                                                    </div>
                                                    <small class="text-muted">Prix calculé proportionnellement</small>
                                                </div>
                                                <small id="custom-price-display" style="display: none;"></small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="lettering-breakdown">
                                    <h6>Détail du calcul :</h6>
                                    <div id="character-count">
                                        <div class="count-item">
                                            <span>Lettres/Chiffres:</span>
                                            <span id="letter-count">0</span> ×
                                            <span id="letter-price">0,00$</span> =
                                            <span id="letter-total">0,00$</span>
                                        </div>
                                        <div class="count-item">
                                            <span>Symboles:</span>
                                            <span id="symbol-count">0</span> ×
                                            <span id="symbol-price">0,00$</span> =
                                            <span id="symbol-total">0,00$</span>
                                        </div>
                                        <div class="count-item">
                                            <span>Espaces:</span>
                                            <span id="space-count">0</span> (gratuits)
                                        </div>
                                        <hr>
                                        <div class="count-item total">
                                            <strong>TOTAL LETTRAGE: <span id="lettering-total">0,00$</span></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Étape 4: Main-d'œuvre -->
                    <div class="form-section">
                        <h4><i class="fas fa-clock"></i> Main-d'œuvre</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="design_hours">Heures de conception</label>
                                    <input type="number" class="form-control" id="design_hours" name="design_hours" 
                                           step="0.25" min="0" value="0">
                                    <small class="form-text text-muted">Temps pour la création graphique</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="installation_hours">Heures d'installation *</label>
                                    <input type="number" class="form-control" id="installation_hours" name="installation_hours" 
                                           step="0.25" min="0.25" required>
                                    <small class="form-text text-muted">Temps pour la pose du lettrage</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Étape 4: Configuration finale -->
                    <div class="form-section">
                        <h4><i class="fas fa-cog"></i> Configuration</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="overhead_config_id">Configuration frais généraux</label>
                                    <select class="form-control" id="overhead_config_id" name="overhead_config_id">
                                        {% for config in overhead_configs %}
                                            <option value="{{ config.id }}" 
                                                    {% if config.is_default %}selected{% endif %}>
                                                {{ config.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="profit_margin">Marge bénéficiaire (%)</label>
                                    <input type="number" class="form-control" id="profit_margin" name="profit_margin" 
                                           value="30" step="0.1" min="0" max="100">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes (optionnel)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Notes supplémentaires sur ce projet..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="form-section text-center">
                        <button type="button" class="btn btn-calculate mr-3" id="calculateBtn">
                            <i class="fas fa-calculator"></i> Calculer le Prix
                        </button>
                        <button type="button" class="btn btn-save-quote" id="saveQuoteBtn" style="display: none;">
                            <i class="fas fa-save"></i> Créer la Soumission
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Résultats du calcul -->
    <div class="row" id="resultsSection" style="display: none;">
        <div class="col-12">
            <div class="calculator-card">
                <div class="calculator-header">
                    <h3><i class="fas fa-chart-line"></i> Détail du Calcul</h3>
                </div>
                <div class="cost-breakdown" id="costBreakdown">
                    <!-- Le détail sera inséré ici par JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('letteringForm');
    const calculateBtn = document.getElementById('calculateBtn');
    const saveQuoteBtn = document.getElementById('saveQuoteBtn');
    const resultsSection = document.getElementById('resultsSection');
    const costBreakdown = document.getElementById('costBreakdown');

    // Prix du lettrage selon le tableau fourni
    const letteringPrices = {
        'petit': {
            'letter': 2.00,
            'symbol': 2.50
        },
        'moyen': {
            'letter': 3.50,
            'symbol': 4.40
        },
        'grand': {
            'letter': 5.00,
            'symbol': 6.25
        }
    };

    // Fonction pour calculer le prix personnalisé basé sur la taille
    function calculateCustomPrice(size) {
        // Calcul proportionnel basé sur la progression des prix existants
        // Petit (3.5cm moyen): 2.00$ / 2.50$
        // Moyen (10.5cm moyen): 3.50$ / 4.40$
        // Grand (23cm moyen): 5.00$ / 6.25$

        // Progression approximative: +0.15$ par cm pour lettres, +0.19$ par cm pour symboles
        const baseLetterPrice = 2.00;
        const baseSymbolPrice = 2.50;
        const letterPricePerCm = 0.15;
        const symbolPricePerCm = 0.19;

        const letterPrice = baseLetterPrice + (size * letterPricePerCm);
        const symbolPrice = baseSymbolPrice + (size * symbolPricePerCm);

        return {
            letter: Math.round(letterPrice * 100) / 100, // Arrondir à 2 décimales
            symbol: Math.round(symbolPrice * 100) / 100
        };
    }

    // Gestion de la sélection du type de travail
    document.querySelectorAll('.work-type-card').forEach(card => {
        card.addEventListener('click', function() {
            // Retirer la sélection précédente
            document.querySelectorAll('.work-type-card').forEach(c => c.classList.remove('selected'));

            // Ajouter la sélection à la carte cliquée
            this.classList.add('selected');

            // Mettre à jour le champ caché
            const workType = this.dataset.type;
            document.getElementById('work_type').value = workType;

            // Afficher/masquer les sections appropriées
            const wrappingSection = document.getElementById('wrapping-section');
            const letteringSection = document.getElementById('lettering-section');
            const calculateBtn = document.getElementById('calculateBtn');

            if (workType === 'wrapping') {
                wrappingSection.style.display = 'block';
                letteringSection.style.display = 'none';
                calculateBtn.innerHTML = '<i class="fas fa-calculator"></i> Calculer le Prix';
                calculateBtn.title = 'Calculer le prix détaillé du wrapping';
            } else if (workType === 'lettering') {
                wrappingSection.style.display = 'none';
                letteringSection.style.display = 'block';
                calculateBtn.innerHTML = '<i class="fas fa-file-invoice"></i> Créer Facture/Soumission';
                calculateBtn.title = 'Créer une facture ou soumission avec le prix calculé';
            }
        });
    });

    // Gestion de l'affichage du champ taille personnalisée
    document.querySelectorAll('input[name="character_size"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const customSizeInput = document.querySelector('.custom-size-input');
            const customPriceDisplay = document.getElementById('custom-price-display');

            if (this.value === 'custom') {
                customSizeInput.style.display = 'block';
                customPriceDisplay.style.display = 'block';
            } else {
                customSizeInput.style.display = 'none';
                customPriceDisplay.style.display = 'none';
            }

            calculateLetteringPrice();
        });
    });

    // Gestion du changement de taille personnalisée
    document.getElementById('custom_size').addEventListener('input', function() {
        const size = parseFloat(this.value);
        const customPriceDisplay = document.getElementById('custom-price-display');

        if (size && size >= 31) {
            const prices = calculateCustomPrice(size);
            customPriceDisplay.textContent = `Lettres: ${prices.letter.toFixed(2)}$ • Symboles: ${prices.symbol.toFixed(2)}$`;
        } else {
            customPriceDisplay.textContent = '';
        }

        calculateLetteringPrice();
    });

    // Fonction pour compter les caractères
    function countCharacters(text) {
        const counts = {
            letters: 0,
            symbols: 0,
            spaces: 0
        };

        for (let char of text) {
            if (char === ' ') {
                counts.spaces++;
            } else if (/[a-zA-Z0-9]/.test(char)) {
                counts.letters++;
            } else {
                counts.symbols++;
            }
        }

        return counts;
    }

    // Fonction pour calculer le prix du lettrage
    function calculateLetteringPrice() {
        const text = document.getElementById('lettering_text').value;
        const sizeRadios = document.querySelectorAll('input[name="character_size"]');
        let selectedSize = null;

        // Trouver la taille sélectionnée
        sizeRadios.forEach(radio => {
            if (radio.checked) {
                selectedSize = radio.value;
            }
        });

        if (!text || !selectedSize) {
            // Réinitialiser l'affichage si pas de données
            document.getElementById('letter-count').textContent = '0';
            document.getElementById('symbol-count').textContent = '0';
            document.getElementById('space-count').textContent = '0';
            document.getElementById('letter-price').textContent = '0,00$';
            document.getElementById('symbol-price').textContent = '0,00$';
            document.getElementById('letter-total').textContent = '0,00$';
            document.getElementById('symbol-total').textContent = '0,00$';
            document.getElementById('lettering-total').textContent = '0,00$';
            return 0;
        }

        const counts = countCharacters(text);
        let prices;

        // Déterminer les prix selon la taille
        if (selectedSize === 'custom') {
            const customSize = parseFloat(document.getElementById('custom_size').value);
            if (!customSize || customSize < 31) {
                // Réinitialiser si taille personnalisée invalide
                document.getElementById('letter-count').textContent = '0';
                document.getElementById('symbol-count').textContent = '0';
                document.getElementById('space-count').textContent = '0';
                document.getElementById('letter-price').textContent = '0,00$';
                document.getElementById('symbol-price').textContent = '0,00$';
                document.getElementById('letter-total').textContent = '0,00$';
                document.getElementById('symbol-total').textContent = '0,00$';
                document.getElementById('lettering-total').textContent = '0,00$';
                return 0;
            }
            prices = calculateCustomPrice(customSize);
        } else {
            prices = letteringPrices[selectedSize];
        }

        const letterTotal = counts.letters * prices.letter;
        const symbolTotal = counts.symbols * prices.symbol;
        const total = letterTotal + symbolTotal;

        // Mettre à jour l'affichage
        document.getElementById('letter-count').textContent = counts.letters;
        document.getElementById('symbol-count').textContent = counts.symbols;
        document.getElementById('space-count').textContent = counts.spaces;
        document.getElementById('letter-price').textContent = prices.letter.toFixed(2) + '$';
        document.getElementById('symbol-price').textContent = prices.symbol.toFixed(2) + '$';
        document.getElementById('letter-total').textContent = letterTotal.toFixed(2) + '$';
        document.getElementById('symbol-total').textContent = symbolTotal.toFixed(2) + '$';
        document.getElementById('lettering-total').textContent = total.toFixed(2) + '$';

        return total;
    }

    // Événements pour le calcul automatique du lettrage
    document.getElementById('lettering_text').addEventListener('input', calculateLetteringPrice);
    document.querySelectorAll('input[name="character_size"]').forEach(radio => {
        radio.addEventListener('change', calculateLetteringPrice);
    });

    // Gestion du changement de client
    document.getElementById('client_id').addEventListener('change', function() {
        const clientId = this.value;
        const vehicleSelect = document.getElementById('vehicle_id');
        
        if (clientId) {
            // Charger les véhicules du client
            fetch(`/clients/${clientId}/vehicles/`)
                .then(response => response.json())
                .then(data => {
                    vehicleSelect.innerHTML = '<option value="">Sélectionnez un véhicule...</option>';
                    data.vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.id;
                        option.textContent = `${vehicle.make} ${vehicle.model} ${vehicle.year || ''}`;
                        option.dataset.complexity = vehicle.complexity_multiplier || 1.0;
                        option.dataset.type = vehicle.vehicle_type || 'Non défini';
                        vehicleSelect.appendChild(option);
                    });
                    vehicleSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    vehicleSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                });
        } else {
            vehicleSelect.innerHTML = '<option value="">Sélectionnez d\'abord un client...</option>';
            vehicleSelect.disabled = true;
        }
    });
    
    // Gestion du changement de véhicule
    document.getElementById('vehicle_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const vehicleInfo = document.getElementById('vehicle_info');
        
        if (this.value) {
            document.getElementById('vehicle_details').textContent = selectedOption.textContent;
            document.getElementById('complexity_multiplier').textContent = selectedOption.dataset.complexity + 'x';
            vehicleInfo.style.display = 'block';
        } else {
            vehicleInfo.style.display = 'none';
        }
    });
    
    // Calcul automatique de la surface avec perte
    function updateSurfaceWithWaste() {
        const surface = parseFloat(document.getElementById('surface_area').value) || 0;
        const waste = parseFloat(document.getElementById('waste_percentage').value) || 0;
        const surfaceWithWaste = surface * (1 + waste / 100);
        document.getElementById('surface_with_waste').value = surfaceWithWaste.toFixed(2) + ' m²';
    }
    
    document.getElementById('surface_area').addEventListener('input', updateSurfaceWithWaste);
    document.getElementById('waste_percentage').addEventListener('input', updateSurfaceWithWaste);
    
    // Calcul du prix
    calculateBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const workType = data.work_type;

        // Validation selon le type de travail
        if (workType === 'wrapping') {
            // Validation pour wrapping
            if (!data.client_id || !data.vehicle_id || !data.surface_area || !data.vinyl_material_id || !data.installation_hours) {
                alert('Veuillez remplir tous les champs obligatoires pour le wrapping.');
                return;
            }
        } else if (workType === 'lettering') {
            // Validation pour lettrage
            if (!data.client_id || !data.vehicle_id || !data.lettering_text || !data.character_size || !data.installation_hours) {
                alert('Veuillez remplir tous les champs obligatoires pour le lettrage.');
                return;
            }

            // Validation spéciale pour taille personnalisée
            if (data.character_size === 'custom' && (!data.custom_size || parseFloat(data.custom_size) < 31)) {
                alert('Veuillez saisir une taille personnalisée d\'au moins 31 cm.');
                return;
            }
        } else {
            alert('Veuillez sélectionner un type de travail.');
            return;
        }
        
        if (workType === 'wrapping') {
            // Traitement pour wrapping (comportement actuel)
            calculateBtn.classList.add('loading');
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calcul en cours...';

            fetch('/api/lettering/calculate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    displayResults(result.breakdown);
                    saveQuoteBtn.style.display = 'inline-block';
                    resultsSection.style.display = 'block';

                    // Scroll vers les résultats
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Erreur: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du calcul');
            })
            .finally(() => {
                calculateBtn.classList.remove('loading');
                calculateBtn.innerHTML = '<i class="fas fa-calculator"></i> Calculer le Prix';
            });

        } else if (workType === 'lettering') {
            // Traitement pour lettrage - création directe de facture/soumission
            const letteringTotal = calculateLetteringPrice();

            if (letteringTotal <= 0) {
                alert('Le prix du lettrage doit être supérieur à 0.');
                return;
            }

            // Ajouter le prix du lettrage aux données
            data.lettering_total = letteringTotal;

            // Afficher le loading
            calculateBtn.classList.add('loading');
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Préparation...';

            // Rediriger vers la création de facture/soumission avec les données
            const params = new URLSearchParams({
                'client_id': data.client_id,
                'vehicle_id': data.vehicle_id,
                'work_type': 'lettering',
                'lettering_text': data.lettering_text,
                'character_size': data.character_size,
                'custom_size': data.custom_size || '',
                'lettering_total': letteringTotal,
                'design_hours': data.design_hours || 0,
                'installation_hours': data.installation_hours,
                'overhead_config_id': data.overhead_config_id,
                'profit_margin': data.profit_margin || 30,
                'notes': data.notes || ''
            });

            // Demander à l'utilisateur s'il veut créer une facture ou une soumission
            if (confirm('Voulez-vous créer une FACTURE (OK) ou une SOUMISSION (Annuler) ?')) {
                window.location.href = `/invoices/new/?${params.toString()}`;
            } else {
                window.location.href = `/quotes/new/?${params.toString()}`;
            }
        }
    });
    
    // Affichage des résultats
    function displayResults(breakdown) {
        const html = `
            <div class="cost-item">
                <span>Surface avec perte (${breakdown.surface_with_waste.toFixed(2)} m²)</span>
                <span></span>
            </div>
            <div class="cost-item">
                <span>• Coût vinyle</span>
                <span>${breakdown.vinyl_cost.toFixed(2)} $</span>
            </div>
            ${breakdown.lamination_cost > 0 ? `
            <div class="cost-item">
                <span>• Coût lamination</span>
                <span>${breakdown.lamination_cost.toFixed(2)} $</span>
            </div>
            ` : ''}
            <div class="cost-item">
                <span><strong>Total matériaux</strong></span>
                <span><strong>${breakdown.material_cost.toFixed(2)} $</strong></span>
            </div>
            
            <div class="cost-item mt-3">
                <span>Main-d'œuvre (complexité: ${breakdown.complexity_multiplier}x)</span>
                <span></span>
            </div>
            ${breakdown.design_cost > 0 ? `
            <div class="cost-item">
                <span>• Conception (${breakdown.design_rate.toFixed(0)}$/h)</span>
                <span>${breakdown.design_cost.toFixed(2)} $</span>
            </div>
            ` : ''}
            <div class="cost-item">
                <span>• Installation (${breakdown.installation_rate.toFixed(0)}$/h × ${breakdown.complexity_multiplier})</span>
                <span>${breakdown.installation_cost.toFixed(2)} $</span>
            </div>
            <div class="cost-item">
                <span><strong>Total main-d'œuvre</strong></span>
                <span><strong>${breakdown.labor_cost.toFixed(2)} $</strong></span>
            </div>
            
            <div class="cost-item mt-3">
                <span>Frais généraux</span>
                <span>${breakdown.overhead_cost.toFixed(2)} $</span>
            </div>

            <div class="cost-item">
                <span><strong>Sous-total avec marge</strong></span>
                <span><strong>${breakdown.subtotal_with_margin.toFixed(2)} $</strong></span>
            </div>

            <div class="cost-item mt-3">
                <span>TPS (${breakdown.gst_rate.toFixed(1)}%)</span>
                <span>${breakdown.gst_amount.toFixed(2)} $</span>
            </div>

            <div class="cost-item">
                <span>TVQ (${breakdown.qst_rate.toFixed(3)}%)</span>
                <span>${breakdown.qst_amount.toFixed(2)} $</span>
            </div>

            <div class="cost-item total">
                <span><strong>PRIX FINAL (taxes incluses)</strong></span>
                <span><strong>${breakdown.final_price_with_taxes.toFixed(2)} $ CAD</strong></span>
            </div>
        `;
        costBreakdown.innerHTML = html;
    }
    
    // Sauvegarde de la soumission
    saveQuoteBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        saveQuoteBtn.classList.add('loading');
        saveQuoteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Création...';
        
        fetch('/api/lettering/save-quote/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(`Soumission ${result.quote_number} créée avec succès!`);
                window.location.href = `/quotes/${result.quote_id}/`;
            } else {
                alert('Erreur: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la sauvegarde');
        })
        .finally(() => {
            saveQuoteBtn.classList.remove('loading');
            saveQuoteBtn.innerHTML = '<i class="fas fa-save"></i> Créer la Soumission';
        });
    });
});
</script>
{% endblock %}
