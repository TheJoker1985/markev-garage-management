{% extends 'garage_app/base.html' %}
{% load static %}

{% block title %}Calendrier des rendez-vous - MarKev{% endblock %}

{% block extra_css %}
<style>
    .calendar-grid {
        border: 1px solid #555;
        border-radius: 8px;
        overflow: hidden;
        background-color: #1e1e1e;
    }
    .calendar-header {
        background-color: #2a2a2a;
        border-bottom: 1px solid #555;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        font-size: 1.2em;
        color: #e0e0e0;
    }
    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background-color: #333;
        border-bottom: 1px solid #555;
    }
    .calendar-weekday {
        padding: 10px;
        text-align: center;
        font-weight: bold;
        border-right: 1px solid #555;
        color: #e0e0e0;
    }
    .calendar-weekday:last-child {
        border-right: none;
    }
    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        min-height: 600px;
        background-color: #1e1e1e;
    }
    .calendar-day {
        border-right: 1px solid #555;
        border-bottom: 1px solid #555;
        min-height: 120px;
        padding: 8px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
        color: #e0e0e0;
    }
    .calendar-day:hover {
        background-color: #2a2a2a;
    }
    .calendar-day:nth-child(7n) {
        border-right: none;
    }
    .calendar-day.other-month {
        background-color: #2a2a2a;
        color: #888;
    }
    .calendar-day.today {
        background-color: #1a3a5c;
        border: 2px solid #4a90e2;
    }
    .calendar-day.selected {
        background-color: #3a3a1a;
        border: 2px solid #ffc107;
    }
    .day-number {
        font-weight: bold;
        margin-bottom: 5px;
        color: #e0e0e0;
    }
    .day-appointments {
        font-size: 0.8em;
        color: #e0e0e0;
    }
    .appointment-mini {
        background-color: #4a90e2;
        color: white;
        padding: 2px 4px;
        margin: 1px 0;
        border-radius: 3px;
        font-size: 0.7em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
    }
    .appointment-mini.status-scheduled {
        background-color: #888;
    }
    .appointment-mini.status-confirmed {
        background-color: #0d6efd;
    }
    .appointment-mini.status-in_progress {
        background-color: #fd7e14;
    }
    .appointment-mini.status-completed {
        background-color: #198754;
    }
    .appointment-mini.status-cancelled {
        background-color: #dc3545;
    }
    .appointment-mini.status-no_show {
        background-color: #6f42c1;
    }
    .appointment-count {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        padding: 0 4px;
        font-size: 0.75em;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .appointment-count:hover {
        transform: scale(1.1);
        box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    .appointment-sidebar {
        max-height: 600px;
        overflow-y: auto;
    }
    .appointment-item {
        border-left: 4px solid #4a90e2;
        margin-bottom: 10px;
        padding: 10px;
        background-color: #2a2a2a;
        border-radius: 0 5px 5px 0;
        cursor: pointer;
        color: #e0e0e0;
    }
    .appointment-item:hover {
        background-color: #3a3a3a;
    }
    .appointment-item.status-confirmed {
        border-left-color: #0d6efd;
    }
    .appointment-item.status-completed {
        border-left-color: #198754;
    }
    .appointment-item.status-cancelled {
        border-left-color: #dc3545;
    }
    .appointment-item.status-in_progress {
        border-left-color: #fd7e14;
    }
    .appointment-item.status-no_show {
        border-left-color: #6f42c1;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Calendrier des rendez-vous</h1>
            <div>
                <a href="{% url 'garage_app:appointment_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nouveau rendez-vous
                </a>
                <a href="{% url 'garage_app:appointment_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-list"></i> Liste
                </a>
            </div>
        </div>

        <!-- Légende des couleurs -->
        <div class="card mb-4">
            <div class="card-body">
                <h6>Légende des statuts :</h6>
                <div class="row">
                    <div class="col-md-2">
                        <span class="badge" style="background-color: #6c757d;">Planifié</span>
                    </div>
                    <div class="col-md-2">
                        <span class="badge" style="background-color: #0d6efd;">Confirmé</span>
                    </div>
                    <div class="col-md-2">
                        <span class="badge" style="background-color: #fd7e14;">En cours</span>
                    </div>
                    <div class="col-md-2">
                        <span class="badge" style="background-color: #198754;">Terminé</span>
                    </div>
                    <div class="col-md-2">
                        <span class="badge" style="background-color: #dc3545;">Annulé</span>
                    </div>
                    <div class="col-md-2">
                        <span class="badge" style="background-color: #6f42c1;">Absence</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-9">
        <!-- Navigation du calendrier -->
        <div class="calendar-nav">
            <button class="btn btn-outline-primary" onclick="changeMonth(-1)">
                <i class="fas fa-chevron-left"></i> Mois précédent
            </button>
            <h4 id="current-month-year"></h4>
            <button class="btn btn-outline-primary" onclick="changeMonth(1)">
                Mois suivant <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <!-- Grille du calendrier -->
        <div class="calendar-grid">
            <div class="calendar-weekdays">
                <div class="calendar-weekday">Dimanche</div>
                <div class="calendar-weekday">Lundi</div>
                <div class="calendar-weekday">Mardi</div>
                <div class="calendar-weekday">Mercredi</div>
                <div class="calendar-weekday">Jeudi</div>
                <div class="calendar-weekday">Vendredi</div>
                <div class="calendar-weekday">Samedi</div>
            </div>
            <div class="calendar-days" id="calendar-days">
                <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                    Chargement du calendrier...
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>
                    <span id="selected-date">Sélectionnez une date</span>
                </h5>
            </div>
            <div class="card-body appointment-sidebar">
                <div id="appointments-list">
                    <p class="text-muted text-center">Cliquez sur une date pour voir les rendez-vous</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript du calendrier chargé');
    let currentDate = new Date();
    let appointments = {};

    // Générer le calendrier initial immédiatement
    generateCalendar();

    // Puis charger les rendez-vous du mois
    loadMonthAppointments();

    // Fonction pour convertir les couleurs en statuts
    function getStatusFromColor(color) {
        const colorMap = {
            '#6c757d': 'scheduled',
            '#0d6efd': 'confirmed',
            '#fd7e14': 'in_progress',
            '#198754': 'completed',
            '#dc3545': 'cancelled',
            '#6f42c1': 'no_show'
        };
        return colorMap[color] || 'scheduled';
    }

    function generateCalendar() {
        try {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Mettre à jour le titre
            const monthNames = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];

            const titleEl = document.getElementById('current-month-year');
            if (titleEl) {
                titleEl.textContent = `${monthNames[month]} ${year}`;
            }

            // Calculer le premier jour du mois et le nombre de jours
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Calculer les jours du mois précédent à afficher
            const prevMonth = new Date(year, month - 1, 0);
            const daysInPrevMonth = prevMonth.getDate();

            const calendarDays = document.getElementById('calendar-days');
            if (!calendarDays) {
                console.error('Element calendar-days non trouvé');
                return;
            }

            calendarDays.innerHTML = '';

            // Ajouter les jours du mois précédent
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayNum = daysInPrevMonth - i;
                const dayEl = createDayElement(dayNum, true, year, month - 1);
                calendarDays.appendChild(dayEl);
            }

            // Ajouter les jours du mois actuel
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (year === today.getFullYear() &&
                               month === today.getMonth() &&
                               day === today.getDate());
                const dayEl = createDayElement(day, false, year, month, isToday);
                calendarDays.appendChild(dayEl);
            }

            // Ajouter les jours du mois suivant pour compléter la grille
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells; // 6 semaines × 7 jours
            for (let day = 1; day <= remainingCells; day++) {
                const dayEl = createDayElement(day, true, year, month + 1);
                calendarDays.appendChild(dayEl);
            }

            console.log('Calendrier généré avec succès');
        } catch (error) {
            console.error('Erreur lors de la génération du calendrier:', error);
        }
    }

    function createDayElement(dayNum, isOtherMonth, year, month, isToday = false) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';

        if (isOtherMonth) {
            dayEl.classList.add('other-month');
        }
        if (isToday) {
            dayEl.classList.add('today');
        }

        // Date pour cette cellule
        const cellDate = new Date(year, month, dayNum);
        const dateStr = cellDate.toISOString().split('T')[0];

        // Numéro du jour
        const dayNumberEl = document.createElement('div');
        dayNumberEl.className = 'day-number';
        dayNumberEl.textContent = dayNum;
        dayEl.appendChild(dayNumberEl);

        // Container pour les rendez-vous
        const appointmentsEl = document.createElement('div');
        appointmentsEl.className = 'day-appointments';
        dayEl.appendChild(appointmentsEl);

        // Ajouter les rendez-vous de ce jour
        if (appointments[dateStr]) {
            const dayAppointments = appointments[dateStr];

            // Afficher seulement le nombre de rendez-vous
            if (dayAppointments.length > 0) {
                const countEl = document.createElement('div');
                countEl.className = 'appointment-count';
                countEl.textContent = dayAppointments.length;
                countEl.title = `${dayAppointments.length} rendez-vous ce jour`;
                dayEl.appendChild(countEl);
            }
        }

        // Gestionnaire de clic pour sélectionner la date
        dayEl.onclick = function(e) {
            // Retirer la sélection précédente
            document.querySelectorAll('.calendar-day.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Sélectionner cette date
            dayEl.classList.add('selected');

            // Charger les rendez-vous de cette date
            loadAppointmentsForDate(dateStr);
        };

        return dayEl;
    }

    function loadMonthAppointments() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Charger les rendez-vous via l'API existante
        fetch('{% url "garage_app:appointment_calendar_api" %}')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Données reçues:', data); // Debug
                appointments = {};

                if (Array.isArray(data)) {
                    data.forEach(event => {
                        try {
                            const eventDate = new Date(event.start);
                            const dateStr = eventDate.toISOString().split('T')[0];

                            if (!appointments[dateStr]) {
                                appointments[dateStr] = [];
                            }

                            // Extraire le titre et le client du titre complet
                            const titleParts = event.title.split(' - ');
                            const appointmentTitle = titleParts[0] || event.title;
                            const clientName = titleParts[1] || event.extendedProps.client || '';

                            appointments[dateStr].push({
                                id: event.id,
                                title: appointmentTitle,
                                client: clientName,
                                vehicle: event.extendedProps.vehicle || '',
                                start_time: eventDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                                end_time: new Date(event.end).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                                status: getStatusFromColor(event.backgroundColor),
                                status_display: event.extendedProps.status || 'Planifié',
                                estimated_price: event.extendedProps.estimated_price || '',
                                description: event.extendedProps.description || ''
                            });
                        } catch (eventError) {
                            console.error('Erreur lors du traitement d\'un événement:', eventError, event);
                        }
                    });
                }

                // Régénérer le calendrier avec les données
                generateCalendar();
            })
            .catch(error => {
                console.error('Erreur lors du chargement des rendez-vous:', error);
                // Générer le calendrier même en cas d'erreur
                generateCalendar();
            });
    }

    // Fonction pour changer de mois
    window.changeMonth = function(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        loadMonthAppointments();
    };

    // Fonction pour charger les rendez-vous d'une date spécifique
    function loadAppointmentsForDate(dateStr) {
        const selectedDateEl = document.getElementById('selected-date');
        const appointmentsListEl = document.getElementById('appointments-list');

        // Formater la date pour l'affichage
        const date = new Date(dateStr);
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        };
        selectedDateEl.textContent = date.toLocaleDateString('fr-FR', options);

        // Afficher les rendez-vous de cette date
        if (appointments[dateStr] && appointments[dateStr].length > 0) {
            let html = '';
            appointments[dateStr].forEach(appointment => {
                html += `
                    <div class="appointment-item status-${appointment.status}" onclick="window.location.href='/appointments/${appointment.id}/'">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${appointment.title}</strong>
                                <br><small class="text-muted">${appointment.client}</small>
                                ${appointment.vehicle ? `<br><small class="text-muted">${appointment.vehicle}</small>` : ''}
                            </div>
                            <div class="text-end">
                                <small>${appointment.start_time} - ${appointment.end_time}</small>
                                <br><span class="badge bg-secondary">${appointment.status_display}</span>
                            </div>
                        </div>
                        ${appointment.estimated_price ? `<div class="mt-2"><small class="text-success">Prix estimé: $${appointment.estimated_price}</small></div>` : ''}
                    </div>
                `;
            });
            appointmentsListEl.innerHTML = html;
        } else {
            appointmentsListEl.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                    <p>Aucun rendez-vous ce jour</p>
                    <a href="{% url 'garage_app:appointment_create' %}?date=${dateStr}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i>Ajouter un rendez-vous
                    </a>
                </div>
            `;
        }
    }
});
</script>
{% endblock %}
